DELIMITER $$

CREATE PROCEDURE ПолучитьСледующееЗначение(
    IN ИмяТаблицы VARCHAR(255),
    IN ИмяСтолбца VARCHAR(255),
    OUT СледующееЗначение INT
)
BEGIN
    DECLARE МаксЗначениеВТаблице INT DEFAULT NULL;
    DECLARE НайденныйИдентификатор INT;

    -- Проверяем, существует ли запись в "СпецТаблица"
    SELECT Идентификатор, ТекущееМаксимальноеЗначение INTO НайденныйИдентификатор, СледующееЗначение
    FROM СпецТаблица
    WHERE ИмяТаблицы = ИмяТаблицы AND ИмяСтолбца = ИмяСтолбца
    LIMIT 1;

    IF НайденныйИдентификатор IS NOT NULL THEN
        -- Если запись найдена, увеличиваем значение
        SET СледующееЗначение = СледующееЗначение + 1;
        UPDATE СпецТаблица
        SET ТекущееМаксимальноеЗначение = СледующееЗначение
        WHERE Идентификатор = НайденныйИдентификатор;
    ELSE
        -- Если записи нет, определяем максимальное значение в указанной таблице
        SET @Запрос = CONCAT('SELECT MAX(', ИмяСтолбца, ') INTO @МаксЗначение FROM ', ИмяТаблицы);
        PREPARE stmt FROM @Запрос;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;

        IF @МаксЗначение IS NULL THEN
            SET МаксЗначениеВТаблице = 0;
        ELSE
            SET МаксЗначениеВТаблице = @МаксЗначение;
        END IF;

        SET СледующееЗначение = МаксЗначениеВТаблице + 1;

        -- Добавляем новую запись в "СпецТаблица"
        INSERT INTO СпецТаблица (Идентификатор, ИмяТаблицы, ИмяСтолбца, ТекущееМаксимальноеЗначение)
        VALUES ((SELECT MAX(Идентификатор) + 1 FROM СпецТаблица), ИмяТаблицы, ИмяСтолбца, СледующееЗначение);

        -- Создание триггера для отслеживания превышения
        SET @TriggerName = CONCAT('Trig_', ИмяТаблицы, '_', ИмяСтолбца, '_UpdateMax');
        SET @TriggerQuery = CONCAT(
            'CREATE TRIGGER ', @TriggerName, '
            AFTER INSERT OR UPDATE ON ', ИмяТаблицы, '
            FOR EACH ROW
            BEGIN
                IF NEW.', ИмяСтолбца, ' > (SELECT ТекущееМаксимальноеЗначение FROM СпецТаблица WHERE ИмяТаблицы = "', ИмяТаблицы, '" AND ИмяСтолбца = "', ИмяСтолбца, '") THEN
                    UPDATE СпецТаблица
                    SET ТекущееМаксимальноеЗначение = NEW.', ИмяСтолбца, '
                    WHERE ИмяТаблицы = "', ИмяТаблицы, '" AND ИмяСтолбца = "', ИмяСтолбца, '";
                END IF;
            END;'
        );

        PREPARE stmt FROM @TriggerQuery;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    END IF;
END$$

DELIMITER ;
